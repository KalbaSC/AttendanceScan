<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>نادي كلباء الرياضي الثقافي - تسجيل الحضور</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'NotoKufiArabic';
      src: url('NotoKufiArabic.ttf') format('truetype');
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'NotoKufiArabic', 'Cairo', sans-serif;
      background: url('black_and_yellow_grunge_background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
    }
    .page-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .header-container {
      background: #111;
      border-bottom: 3px solid #f4e733;
    }
    .header-right {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      flex-wrap: wrap;
    }
    .logo {
      height: 36px;
    }
    .divider {
      width: 1.5px;
      height: 30px;
      background-color: #f4e733;
    }
    .header-info {
      text-align: center;
    }
    .arabic-name {
      font-weight: bold;
      font-size: 12px;
    }
    .english-name {
      font-size: 10px;
      color: #f4e733;
    }
    main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #reader {
      width: 100%;
      max-width: 360px;
      border: 3px solid #f4e733;
      border-radius: 16px;
      overflow: hidden;
      background: black;
      aspect-ratio: 1;
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      background: black;
      border-radius: 10px;
      color: #f4e733;
      font-size: 15px;
    }
    #scanner-section {
      width: 100%;
      max-width: 400px;
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 16px;
      border: 2px solid #f4e733;
      text-align: center;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .manual-entry {
      margin-top: 25px;
    }
    @keyframes pulse {
      0% { border-color: rgba(244, 231, 51, 0.4); }
      50% { border-color: rgba(244, 231, 51, 1); }
      100% { border-color: rgba(244, 231, 51, 0.4); }
    }
    footer {
      background-color: #111;
      color: white;
      text-align: center;
      padding: 16px;
      border-top: 3px solid #f4e733;
      font-size: 12px;
    }
    .social-icons a {
      color: white;
      margin: 0 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <header class="header-container">
      <div class="header-right">
        <img src="Picture3.png" alt="شعار الشارقة" class="logo">
        <div class="divider"></div>
        <img src="logo.png" alt="شعار نادي كلباء" class="logo">
        <div class="header-info">
          <div class="arabic-name">نادي كلباء الرياضي الثقافي</div>
          <div class="english-name">KALBA SPORTS & CULTURAL CLUB</div>
        </div>
      </div>
    </header>

    <main>
      <div id="scanner-section">
        <h3 style="color: #f4e733;">وجه الكاميرا نحو رمز QR الخاص بالطفل</h3>
        <div style="position: relative; margin: 0 auto;">
          <div id="reader"></div>
          <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 3px dashed rgba(255,255,255,0.4); border-radius: 16px; animation: pulse 2s infinite ease-in-out; pointer-events: none;"></div>
        </div>
        <div id="status">يرجى توجيه الكاميرا نحو رمز QR الخاص باللاعب</div>
        <div class="manual-entry">
          <label for="manualId">أدخل رقم الطفل:</label>
          <input type="text" id="manualId" placeholder="مثال: KalbaSC-17197482 أو الرقم فقط">
          <button onclick="submitManual()">تسجيل يدوي</button>
        </div>
      </div>
    </main>

    <footer>
      <p>© 2025 نادي كلباء الرياضي الثقافي - جميع الحقوق محفوظة</p>
      <p style="font-size: 12px; color: #aaa; margin-top: -10px;">تم التطوير بواسطة روند أحمد الضمور</p>
      <div class="social-icons">
        <a href="https://facebook.com/Kalbasc1" target="_blank"><i class="fab fa-facebook-f"></i></a>
        <a href="https://instagram.com/kalbasc" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://x.com/Kalba_sc" target="_blank"><i class="fab fa-twitter"></i></a>
        <a href="https://youtube.com/@kalbasc" target="_blank"><i class="fab fa-youtube"></i></a>
        <a href="https://tiktok.com/@kalbasc" target="_blank"><i class="fab fa-tiktok"></i></a>
      </div>
    </footer>
  </div>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const config = {
      fps: 30,
      qrbox: { width: 250, height: 250 },
      rememberLastUsedCamera: true,
      aspectRatio: 1.0,
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };

    let scannerStarted = false;
    function startScanner() {
      if (scannerStarted) return;
      Html5Qrcode.getCameras().then(devices => {
        if (devices.length === 0) {
          alert("❌ لم يتم العثور على كاميرا.");
          return;
        }
        let backCamera = devices.find(device =>
          device.label.toLowerCase().includes('back') ||
          device.label.toLowerCase().includes('environment')) || devices[0];
        scannerStarted = true;
        html5QrCode.start(
          backCamera.id,
          config,
          msg => {
            html5QrCode.stop();
            scannerStarted = false;
            markAttendance(msg);
          },
          err => {}
        );
      }).catch(() => alert("⚠️ تعذر تشغيل الكاميرا."));
    }

    function markAttendance(code) {
      const parts = code.split('|');
      const id = parts[0] || "UNKNOWN";
      const encodedName = parts[1] || "UNKNOWN";
      const encodedParent = parts[2] || "UNKNOWN";
      const name = decodeURIComponent(encodedName);
      const parent = decodeURIComponent(encodedParent);
      document.getElementById("status").innerHTML = `✅ تم تسجيل الحضور<br>الاسم: ${name}<br>ولي الأمر: ${parent}`;
      const data = new FormData();
      data.append("id", id);
      data.append("name", name);
      data.append("parent", parent);
      data.append("date", new Date().toISOString());
      fetch("https://script.google.com/macros/s/AKfycbx5q8uqZle52sfH-dPuil6JV_rXJaIDBZlWBKkEdn93MZgGhrdPssui4JM2lj5jEGx7jQ/exec", {
        method: "POST",
        mode: "no-cors",
        body: data
      });
      setTimeout(() => startScanner(), 4000);
    }

    function submitManual() {
      const input = document.getElementById("manualId").value.trim();
      if (!input) return alert("يرجى إدخال كود الطفل أو الرقم.");
      const match = input.match(/KalbaSC-(\d+)/) || input.match(/^(\d{6,})$/);
      if (!match) return alert("⚠️ يرجى إدخال الكود بالشكل الصحيح.");
      const idOnly = match[1];
      fetch(`https://script.google.com/macros/s/AKfycbzXwkw2AEELlxtMbMXLGq1sJhzlG6FlF7CtaZfQGSzNJd8UqAepgrMNjTgTNlGe_Nsb1Q/exec?id=${idOnly}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) return alert("❌ لم يتم العثور على هذا الرقم.");
          const qr = `KalbaSC-${idOnly}|${encodeURIComponent(data.name)}|${encodeURIComponent(data.parent)}`;
          markAttendance(qr);
        })
        .catch(() => alert("⚠️ تعذر الاتصال بالخادم."));
    }

    // Auto start scanner on page load
    window.onload = startScanner;
  </script>
</body>
</html>
